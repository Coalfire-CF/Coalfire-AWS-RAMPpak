---
- name: Load AWS vars
  ansible.builtin.include_vars: aws.yml
  when: ansible_system_vendor == 'Amazon EC2'

- name: Add Random Password to AWS SSM Parameter Store
  community.aws.ssm_parameter:
    name: "{{ ad_secrets_path }}svc_uat_priv"
    state: present
    string_type: "SecureString"
    value: "{{ lookup('community.general.random_string', min_lower=1, min_upper=1, min_special=1, override_special='_%@!', min_numeric=1, length=15) }}"
    region: "{{ aws_region }}"
    key_id: "{{ ssm_parameter_store_key_id }}"
    endpoint_url: "{{ ssm_endpoint }}"
  delegate_to: localhost
  when:
    - ansible_system_vendor == 'Amazon EC2'
    - svc_uat_priv_password | length == 0

- name: Add Random Password to AWS SSM Parameter Store
  community.aws.ssm_parameter:
    name: "{{ ad_secrets_path }}svc_uat_unpriv"
    state: present
    string_type: "SecureString"
    value: "{{ lookup('community.general.random_string', min_lower=1, min_upper=1, min_special=1, override_special='_%@!', min_numeric=1, length=15) }}"
    region: "{{ aws_region }}"
    key_id: "{{ ssm_parameter_store_key_id }}"
    endpoint_url: "{{ ssm_endpoint }}"
  delegate_to: localhost
  when:
    - ansible_system_vendor == 'Amazon EC2'
    - svc_uat_unpriv_password | length == 0

- name: Create UAT Privileged Testing Account
  microsoft.ad.user:
    name: svc_uat_priv
    firstname: Service
    surname: UAT Privileged
    description: This is an account for User Acceptance Testing, it should be deleted when testing is done.
    sam_account_name: svc_uat_priv
    upn: "svc_uat_priv@{{ ansible_domain }}"
    password_never_expires: false
    path: "OU=Administrators,OU=Management,OU=All Users,{{ dom_disname }}"
    password: "{{ svc_uat_priv_password }}"
    update_password: when_changed
    groups:
      add:
        - WindowsAdmins
        - LinuxAdmins

- name: Create UAT Unprivileged Testing service account
  microsoft.ad.user:
    name: svc_uat_unpriv
    firstname: Service
    surname: UAT Unprivileged
    description: This is an account for User Acceptance Testing, it should be deleted when testing is done.
    sam_account_name: svc_uat_unpriv
    upn: "svc_uat_unpriv@{{ ansible_domain }}"
    password_never_expires: false
    path: "OU=Administrators,OU=Management,OU=All Users,{{ dom_disname }}"
    password: "{{ svc_uat_unpriv_password }}"
    update_password: when_changed
